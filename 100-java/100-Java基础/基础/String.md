# 1 为何JDK9要将String底层实现由chat[]改成byte[]
在JDK 9中，Java的字符串实现确实发生了重大变化，底层存储从 `char[]` 改为了 `byte[]`。这个改变的主要原因包括优化内存使用和提升性能，尤其是在处理字符串时。

## 1.1 内存效率

- **减少内存占用**：在JDK 8及之前的版本，`String` 类使用 `char[]` 来存储字符。由于Java的字符采用 UTF-16 编码，每个字符使用两个字节（16位），尤其是对于大多数自然语言字符，可以说是浪费了大量内存。在JDK 9引入的新实现中，字符串底层使用 `byte[]`，并结合一种新的 `Coder` 机制来区分不同的字符编码。

- **使用压缩字符串**：在JDK 9中，`String` 类可以根据需要使用不同的编码（例如 Latin-1 或 UTF-16）。当字符串只包含拉丁字符时，它可以更高效地存储为一个字节数组，只占用一个字节，而只在需要表示其他字符时才使用两个字节。通过这种方式，可以大幅度减少字符串在内存中的占用。

## 1.2 性能优化

- **加快字符串操作**：由于减少了内存占用，尤其是当大量字符串对象在内存中时，这种变化有助于更快的内存访问和更好的缓存利用。更少的内存占用意味着更高的内存局部性，能够提高在 CPU Cache 中的命中率，从而提升整体性能。

- **字符串转义效率**：字符串的转义和转换，比如从 `String` 转换为 bytes 或从 bytes 转换为 `String` 时，使用 `byte[]` 的方式能够减少转换过程中的复杂性和时间开销。

## 1.3 兼容性

- **保留向后兼容**：虽然底层实现发生了改变，但对于现有的代码，总体上并不影响其兼容性。Java 的 `String` API 保持不变，开发者不需要关心底层的实现细节，而是可以继续使用熟悉的字符串操作。

## 1.4 示例代码

在JDK 9之前，字符串是用 `char[]` 数组存储的，如下所示：

```java
public final class String {
    private final char value[];
    
    // 构造器，方法等
}
```

而在JDK 9及之后的版本中，字符串实现大致如下（简化表示）：

```java
public final class String {
    private final byte value[];
    private final int offset;
    private final int count;
    
    // 构造器，方法等
}
```

通过以上变化，Java 9 提高了字符串的内存效率和性能，特别是在处理大量字符串时，能够显著降低内存消耗，提高应用的整体响应速度和效率。
