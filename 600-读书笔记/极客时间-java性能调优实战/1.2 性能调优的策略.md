# 如何制定性能调优策略
测试 - 分析 - 调优
## 性能测试方式
1. 微基准性能测试
    > 微基准性能测试可以精准定位到某个模块或者某个方法的性能问题，特别适合做一个功能模块或者一个方法在不同实现方式下的性能对比

2. 宏基准性能测试
    > 宏基准性能测试是一个综合测试，需要考虑到测试环境、测试场景和测试目标
   1. 首先看测试环境，我们需要模拟线上的真实环境
   2. 然后看测试场景。我们需要确定在测试某个接口时，是否有其他业务接口同时也在平行运行，造成干扰。如果有，请重视，因为你一旦忽视了这种干扰，测试结果就会出现偏差
   3. 最后看测试目标。我们的性能测试是要有目标的，这里可以通过吞吐量以及响应时间来衡量系统是否达标。
        > 不达标，就进行优化；达标，就继续加大测试的并发数，探底接口的 TPS（最大每秒事务处理量），这样做，可以深入了解到接口的性能。除了测试接口的吞吐量和响应时间以外，我们还需要循环测试可能导致性能问题的接口，观察各个服务器的 CPU、内存以及 I/O 使用率的变化。

## 性能测试注意问题
1. 热身问题     
    > 当我们做性能测试时，我们的系统会运行得越来越快，后面的访问速度要比我们第一次访问的速度快上几倍。这是怎么回事呢？

    在Java 编程语言和环境中，.java 文件编译成为 .class 文件后，机器还是无法直接运行 .class 文件中的字节码，需要通过解释器将字节码转换成本地机器码才能运行。为了节约内存和执行效率，代码最初被执行时，解释器会率先解释执行这段代码。

    随着代码被执行的次数增多，当虚拟机发现某个方法或代码块运行得特别频繁时，就会把这些代码认定为热点代码（Hot Spot Code）。为了提高热点代码的执行效率，在运行时，虚拟机将会通过即时编译器（JIT compiler，just-in-time compiler）把这些代码编译成与本地平台相关的机器码，并进行各层次的优化，然后存储在内存中，之后每次运行代码时，直接从内存中获取即可。

    所以在刚开始运行的阶段，虚拟机会花费很长的时间来全面优化代码，后面就能以最高性能执行了。

    这就是热身过程，如果在进行性能测试时，热身时间过长，就会导致第一次访问速度过慢，你就可以考虑先优化，再进行测试。

2. 性能测试结果不稳定
   > 我们在做性能测试时发现，每次测试处理的数据集都是一样的，但测试结果却有差异。这是因为测试时，伴随着很多不稳定因素，比如机器其他进程的影响、网络波动以及每个阶段 JVM 垃圾回收的不同等等。

   我们可以通过多次测试，将测试结果求平均，或者统计一个曲线图，只要保证我们的平均值是在合理范围之内，而且波动不是很大，这种情况下，性能测试就是通过的。
3. 多 JVM 情况下的影响
   > 如果我们的服务器有多个 Java 应用服务，部署在不同的 Tomcat 下，这就意味着我们的服务器会有多个 JVM。
   
   任意一个 JVM 都拥有整个系统的资源使用权。如果一台机器上只部署单独的一个 JVM，在做性能测试时，测试结果很好，或者你调优的效果很好，但在一台机器多个 JVM 的情况下就不一定了。
   
   所以我们应该尽量避免线上环境中一台机器部署多个 JVM 的情况。

## 分析结果
1. 输出性能测试报告，包含以下纬度数据。
    + 测试接口的平均、最大和最小吞吐量，响应时间
    + 服务器的 CPU、内存、I/O、网络 IO 使用率
    + JVM 的 GC 频率
2. 测试报告分析思路是：自上而下方式分析
   + 操作系统：CPU、内存、I/O、网络4大计算机资源的使用率 
   + JVM：垃圾回收频率、内存分配情况 
   + 应用：应用日志
    > 如果系统和 JVM 层面都没有出现异常情况，我们可以查看应用服务业务层是否存在性能瓶颈，例如 Java 编程的问题、读写数据瓶颈等等。


## 制定调优策略
1. 优化代码
    > 应用层的问题代码往往会因为耗尽系统资源而暴露出来。
    + 某段代码导致内存溢出，将JVM中内存用完的同时引发JVM频繁垃圾回收，导致CPU资源不足。
    + LinkedList集合使用for遍历，在每次获取元素时都会去遍历一次list，降低读效率。课该用Iterator(迭代器)循环该集合

2. 优化设计
    > 设计模式，可以帮助我们优化业务层以及中间件层的代码设计。优化后，不仅可以精简代码，还能提高整体性能。
    + 单例模式在频繁调用创建对象的场景中，可以共享一个创建对象，这样可以减少频繁地创建和销毁对象所带来的性能消耗

3. 优化算法
4. 时间换空间
5. 空间换时间
    > 这种方法是使用存储空间来提升访问速度。现在很多系统都是使用的 MySQL 数据库，较为常见的分表分库是典型的使用空间换时间的案例。

    > 因为 MySQL 单表在存储千万数据以上时，读写性能会明显下降，这个时候我们需要将表数据通过某个字段 Hash 值或者其他方式分拆，系统查询数据时，会根据条件的 Hash 值判断找到对应的表，因为表数据量减小了，查询性能也就提升了。
6. 参数调优
    > JVM、Web 容器以及操作系统的优化
    + 如果我们业务中会创建大量的大对象，我们可以通过设置，将这些大对象直接放进老年代。这样可以减少年轻代频繁发生小的垃圾回收（Minor GC），减少 CPU 占用时间，提升系统性能
7. 兜底策略
   1. 限流
        > 对系统的入口设置最大访问限制。这里可以参考性能测试中探底接口的 TPS 。同时采取熔断措施，友好地返回没有成功的请求。
   2. 实现智能化横向扩容
        > 智能化横向扩容可以保证当访问量超过某一个阈值时，系统可以根据需求自动横向新增服务。
   3. 提前扩容
        > 这种方法通常应用于高并发系统，例如，瞬时抢购业务系统。这是因为横向扩容无法满足大量发生在瞬间的请求，即使成功了，抢购也结束了